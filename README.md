
# バリデーションコンペ

## 1. コンペの目的

大学内ロッカー申請の入力データ（Googleフォーム出力CSV）には、欠損・重複・不整合などにより、抽選等の後段処理に回せない応募が混入する。
本コンペでは、申請データのバリデーション（有効/無効判定）と、無効データの理由（エラーコード）付与、および有効データの階別CSV出力を行う仕組みを実装し、その正確性を競う。

---

## 2. 入力（2種類のCSV）

入力は常に以下の **2ファイル**。

### 2.1 申請者用フォームCSV

申請者フォームからの出力。主に以下を含む：

* タイムスタンプ（Googleフォーム自動付与）
* メールアドレス
* 申請者の学籍番号・氏名
* 申請者の学生証写真URL
* 共同利用者の有無
* 希望階（2〜6のいずれか）
* 共同利用者の学籍番号・氏名（共同利用ありの場合）

**ヘッダー**
`タイムスタンプ,メールアドレス,規約への同意,申請者の学籍番号,申請者の氏名,申請者の学生証写真,共同利用者の有無,共同利用者の学籍番号,共同利用者の氏名, 階数希望選択（共同利用者なし）,階数希望選択（共同利用者あり）,`

**階数列の扱い**

* 「階数希望選択（共同利用者なし）」と「階数希望選択（共同利用者あり）」は どちらか一方のみが埋まり、もう片方は常に空。
* 参加者はデータを見て、有効な階数が入っている列を採用すること。

**申請者の学生証写真URLの扱い**

* 本来であれば、学生証のURLが記載されるが、今回は簡略化のため、accept, deniedのどちらかをとる。
* acceptであれば、アップロードされた学生証写真が有効であったことを意味する。
* diniedであれば、アップロードされた学生写真が無効であることを意味する。

### 2.2 共同利用者用フォームCSV

共同利用者フォームからの出力。主に以下を含む：

* タイムスタンプ
* メールアドレス
* 共同利用者の学籍番号・氏名
* 共同利用者の学生証写真URL

**ヘッダー例（固定）**
`タイムスタンプ,メールアドレス,規約への同意,共同利用者の学籍番号,共同利用者の氏名,共同利用者の学生証写真`

**共同利用者の学生証写真URLの扱い**

* 本来であれば、学生証のURLが記載されるが、今回は簡略化のため、accept, deniedのどちらかをとる。
* acceptであれば、アップロードされた学生証写真が有効であったことを意味する。
* diniedであれば、アップロードされた学生写真が無効であることを意味する。

### 2.3 期間について

本コンペは抽選が複数回あることを仮定している。そのため、複数期間が存在し、それぞれの期間において採用の有無を決定しなければならない。期間は1週間とする。


---

## 3. バリデーション要件

以下は、バリデーションの一例である。必ずしもすべてのルールが記載されているわけではないことに注意すること。
**データの性質を理解するために、実際のフォームを確認することをオススメする。**

### 3.1 学籍番号の形式

学籍番号は 7桁の数字で、次のいずれかのパターンに一致するものとする。

* 先頭が「15」ではじまり、残りは数字5桁
* 先頭が「4」または「8」ではじまり、2桁目は「1」〜「6」、残りは数字5桁

このルールに沿わない学籍番号は無効扱いとする

### 3.2 複数提出の扱い

申請者もしくは、共同利用者が複数回提出を行い、マッチングが難しくなるケースがある。
そのため、以下のルールに従い、マッチングを行うとする。

- 同一人物から複数提出が行われた場合、その人物に有効なフォームは最新のもののみである。
- 特定の人物と異なる人物とのペアが複数ある場合、有効であるデータのうち、提出タイミングが早いものが採用される。
- 共同利用者の提出タイミングは申請者の提出タイミングよりも優先される。
- 細かいルールについては備考を参照してほしい。

他のペアとマッチングが行われてしまい、あふれてしまった申請はすべて無効とする。

### 3.3 当選済み

1回目にロッカーを登録に採用されたものは2回目にロッカーを登録することができない。
2回目の申請だけを無効にする必要がある。

### 備考

複数提出が発生する事案として以下が考えられる。

**(A) 同一人物の多重応募

同一学籍番号が複数応募に現れる場合、存在するフォームで有効な最新のデータを優先する。

Xさんが申請者としてフォームAとBを順に提出し、その後共同利用者としてフォームCを提出した場合、有効であるのはＣだけである。(すべての回答が有効であることが前提) また、この後にXさんが申請者としてフォームDを提出した場合、有効であるのはDだけであり、Cは無効となる。

**(B) 異なるペアを組む競合

異なるペアで応募している場合、もっとも提出が早かったペアが優先される。

申請者Xが、フォームAではY、フォームBではZが共同利用者となっている場合、共同利用者の回答が早いペアのみ採用し、遅い方を無効とする。共同利用者Yのフォームが有効であれば、Yが採用される。つまり、XとYのペアが採用される。

---

## 4. 出力

出力は1期間に対して、以下の6ファイルを生成する。

### 4.1 有効データ（階別）: `valid_2F.csv`〜`valid_6F.csv`

* 有効と判定された応募のみ出力
* 各ファイルの列：

  1. 申請者学籍番号
  2. 申請者氏名
  3. 共同利用者学籍番号
  4. 共同利用者氏名

* 1人利用の場合は共同利用者2列を 空欄 とする
* 申請者学籍番号の昇順でソートして出力

### 4.2 無効データ: `invalid_app.csv, invalid_par.csv`

有効、無効 (無効の場合はエラーコード) を出力する。
列：
申請者、共同利用者の入力CSVの最後の列に、「結果」というカラムを作成し、結果を記載する。

タイムスタンプでソートして出力 (入力データと同じ順番)
成功コード、エラーコードはのちに記載。

### 4.3 フォルダ構造

以下のようなフォルダー構造にします。1期間ごとに

```
output/
├─ term1/
│  ├─ valid_2F.csv
│  ├─ valid_3F.csv
│  ├─ valid_4F.csv
│  ├─ valid_5F.csv
│  ├─ valid_6F.csv
│  ├─ invalid_app.csv
│  └─ invalid_par.csv
└─ term2/
   ├─ valid_2F.csv
   ├─ valid_3F.csv
   ├─ valid_4F.csv
   ├─ valid_5F.csv
   ├─ valid_6F.csv
   ├─ invalid_app.csv
   └─ invalid_par.csv
... (termがもっとある場合は複数出す)
```

### 4.4 成功コード、エラーコード

| コード | 名称         | 発生条件                                                   |
| --- | ---------- | ------------------------------------------------------ |
| S0  | 成功コード      | 有効であるデータすべてに付与する。後の抽選に利用できるデータのこと。                     |
| E1  | 入力値エラー     | 与えられたフォームに存在しない学籍番号など無効なデータ入力値があったり、情報が欠落している場合に出力を行う。 |
| E2  | 当選済みエラー    | 過去に、ロッカー登録に採用されており無効となった申請があるときに出力を行う                  |
| E3  | マッチング済みエラー | 申請者もしくは共同利用者が他のペアとすでに組まれてしまい、あふれてしまったデータがある場合に出力を行う。   |

末尾の番号が小さい方を優先的にエラーコードに出力しなければならない。
例えば、入力値エラーとマッチング済みエラーの両方が発生していても、番号の小さいE1がエラーコードとして採用される。

---

## 5. 評価方法

運営側は正解データ（有効/無効判定およびエラーコード）を保持する。
正解数に応じて点数が与えられる。
